

```{r libraries, echo=FALSE}

library(here)
library(vegan)
```


```{r data-import, echo=FALSE}

source(here::here("R", "hydro_metrics.R"))
source(here::here("R", "hysteresis_calcs.R"))
```

Plot of of cumQ v. totalLoad. Next step here is to get at the residuals.
```{r cumQ-totalLoad}

hydroMetrics %>% 
  ggplot(aes(x = cumQ, y = totalLoad)) +
  geom_point() +
  geom_text(aes(label = stormMark), hjust = "right", vjust = "top", nudge_x = 0) +
  scale_x_log10() +
  # scale_y_log10() +
  facet_wrap(~ analyte, scales = "free")
```


Plot of Flusing Index v. HImean having joined hydroMetrics + hysteresisIndices + contributingGauges. Here grouped by `monsoon` but change grouping variable to whatever parameter is of interest (e.g., `reachLength`). 
```{r hysteretic-reponses}

hydroMetrics %>% 
  inner_join(
    hysteresisIndices,
    by = c("stormMark", "analyte")
  ) %>% 
  inner_join(
    contributingGauges,
    by = c("stormMark")
  ) %>% 
  ggplot(aes(x = FI, y = HImean)) + 
  lims(x = c(-1, 1), y = c(-1, 1)) +
  geom_vline(xintercept = 0, colour = "gray") +
  geom_hline(yintercept = 0, colour = "gray") +
  geom_point(aes(colour = fromLakeMarguerite)) + # grouping var.
  facet_wrap(~ analyte) +
  theme_minimal()

```


Shotgun scatterplot everything v. everything.
```{r scatterplot}

hydroMetrics %>% 
  inner_join(
    hysteresisIndices,
    by = c("stormMark", "analyte")
  ) %>% 
  inner_join(
    contributingGauges,
    by = c("stormMark")
  ) %>% 
  select(totalLoad:fromInterceptor) %>% 
  pairs()
```


Boxplots of totalLoad per grouping variable, here reachLength but change x to parameter of interest.
```{r boxplots}

hydroMetrics %>% 
  inner_join(
    hysteresisIndices,
    by = c("stormMark", "analyte")
  ) %>% 
  inner_join(
    contributingGauges,
    by = c("stormMark")
  ) %>% 
  ggplot(aes(x = reachLength, y = totalLoad)) +
  geom_boxplot() +
  facet_wrap(~ analyte, scales = "free")
```


```{r function-nmds-hystersis, echo=FALSE}

# function to generate a PCA/RDA of hysteresis metrics HImean and FI. input
# parameter (chemSpecies) is the quoted name of the analyte of interest (e.g.,
# "ClD_LACHAT")

generate_nmds <- function(chemSpecies) {
  
  hydroMetrics %>% 
    inner_join(
      hysteresisIndices,
      by = c("stormMark", "analyte")
    ) %>% 
    inner_join(
      contributingGauges,
      by = c("stormMark")
    ) %>% 
    filter(analyte == chemSpecies) %>%
    select(stormMark, HImean, FI) -> chemSpeciesData
  
  chemSpeciesData <- as.data.frame(chemSpeciesData) # to data frame
  rownames(chemSpeciesData) <- chemSpeciesData$stormMark # stormMark to row name
  chemSpeciesData <- chemSpeciesData[,c("HImean", "FI")] # remove stormMark col
  
  # NMDS
  ibsNMDS <- metaMDS(chemSpeciesData) # NMDS
  
  # PCA
  # ibwPCA <- rda(chemSpeciesData) # PCA
  
  return(ibsNMDS)
  
}

# example
# nmdsOut <- generate_nmds("NO3D_LACHAT")
# ordiplot(nmdsOut, type = "text", display = "sites")
```


```{r function-rda-hystersis, echo=FALSE}

# function to generate a PCA/RDA of hysteresis metrics HImean and FI. input
# parameter (chemSpecies) is the quoted name of the analyte of interest (e.g.,
# "ClD_LACHAT")

generate_rda <- function(chemSpecies) {
  
  hydroMetrics %>% 
    inner_join(
      hysteresisIndices,
      by = c("stormMark", "analyte")
    ) %>% 
    inner_join(
      contributingGauges,
      by = c("stormMark")
    ) %>% 
    filter(analyte == chemSpecies) %>%
    select(stormMark, HImean, FI) -> chemSpeciesData
  
  chemSpeciesData <- as.data.frame(chemSpeciesData) # to data frame
  rownames(chemSpeciesData) <- chemSpeciesData$stormMark # stormMark to row name
  chemSpeciesData <- chemSpeciesData[,c("HImean", "FI")] # remove stormMark col
  
  # NMDS
  # clNMDS <- metaMDS(clNMDS) # NMDS
  # ordiplot(clNMDS, type = "text", display = "sites")
  
  # PCA
  ibwPCA <- rda(chemSpeciesData) # PCA
  
  return(ibwPCA)
  
}

# example
# clPCA <- generate_pca("ClD_LACHAT")
# plot(clRDA)
# biplot(clRDA)
```


```{r funciton-envfit-hysteresis, echo=FALSE}

# function to fit environmental variables to a PCA/RDA. input parameters include
# the result of a successful PCA (ordination) and (chemSpecies) is the quoted
# name of the analyte of interest (e.g., "ClD_LACHAT")

generate_envfit <- function(ordination, chemSpecies) {
  
  hydroMetrics %>% 
    inner_join(
      hysteresisIndices,
      by = c("stormMark", "analyte")
    ) %>% 
    inner_join(
      contributingGauges,
      by = c("stormMark")
    ) %>% 
    inner_join(
      ibwPrecipitation %>% select(stormMark, IDW_IDP2),
      by = c("stormMark")
    ) %>% 
    filter(analyte == chemSpecies) %>%
    select(-analyte, -b, -HImean, -CQpeak, -CQinit, -FI) -> envData
  
  envData <- as.data.frame(envData) # to data frame
  rownames(envData) <- envData$stormMark # stormMark to row name
  envData <- subset(envData, select = -c(stormMark)) # remove stormMark col
  
  envDataFit <- envfit(ordination, envData, permutations = 999)
  
  return(envDataFit)
  
}

# example
# rdaOut <- generate_rda("ClD_LACHAT")
# envFit <- generate_envfit(rdaOut, "ClD_LACHAT")
# plot(rdaOut)
# plot(envFit)
# plot(envFit, p.max = 0.1)
```


```{r}

hystRDA <- generate_rda("NO3D_LACHAT")
hystENV <- generate_envfit(hystRDA, "NO3D_LACHAT")

plot(hystRDA)
plot(hystENV)
plot(hystENV, p.max = 0.1)
```

```{r}

hydroMetrics %>% 
  filter(analyte == "ClD_LACHAT") %>% 
  lm(cumQ ~ totalLoad)
  
fit <- lm(mpg ~ hp, data = hydroMetrics[hy])  # Fit the model
```

